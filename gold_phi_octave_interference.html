<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Moiré Cosmique : Interférence Φⁿ vs 2ᵐ</title>
  <script src="http://127.0.0.1:8080/ipfs/QmXpfqQNgk6g9BtcQMxHMGeSHqLqc9DJQu3MjMWRREp3Ui/p5.min.js"></script>
  <script src="http://127.0.0.1:8080/ipfs/QmXpfqQNgk6g9BtcQMxHMGeSHqLqc9DJQu3MjMWRREp3Ui/p5.sound.min.js"></script>
  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #000; color: #eee; overflow: hidden; }
    canvas { display: block; }
    .overlay { position: absolute; z-index: 10; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); border-radius: 8px; padding: 15px; }
    #top-display { top: 10px; left: 50%; transform: translateX(-50%); width: calc(100% - 40px); max-width: 800px; display: flex; justify-content: space-around; text-align: center; }
    #main-controls { top: 80px; left: 10px; width: 320px; }
    details { border: 1px solid #444; border-radius: 4px; margin-top: 10px; }
    summary { font-weight: bold; cursor: pointer; padding: 10px; background-color: #222; }
    .accordion-content { padding: 10px; }
    label { display: block; margin-top: 12px; font-size: 14px; }
    input[type="range"] { width: 100%; }
    input[type="date"] { width: 95%; padding: 5px; background: #333; border: 1px solid #555; color: white; }
    button { margin-top: 15px; width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
    button:hover { background-color: #0056b3; }
    #top-coherences ul { list-style-type: none; padding: 0; max-height: 40vh; overflow-y: auto; }
    #top-coherences li { background: #1a1a1a; padding: 10px; margin-bottom: 5px; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; font-size: 13px; }
    .color-swatch { width: 20px; height: 20px; border: 1px solid #555; margin-right: 10px; }
    .play-btn { background: #28a745; color: white; border: none; cursor: pointer; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; line-height: 24px; text-align: center; }
    .play-btn.playing { background: #dc3545; }
    #scan-status { text-align: center; margin-top: 10px; color: #ffc107; }
  </style>
</head>
<body>

  <div id="top-display" class="overlay">
    <div>Onde Dorée (Φⁿ)<br><span id="fPhiDisplay" style="color:gold; font-weight:bold;"></span></div>
    <div>Onde Octavienne (2ᵐ)<br><span id="fTwoDisplay" style="color:skyblue; font-weight:bold;"></span></div>
    <div>Cohérence<br><span id="coherenceDisplay" style="color:lime; font-weight:bold;"></span></div>
  </div>

  <div id="main-controls" class="overlay">
    <details open>
      <summary>Personnalisation (Déphasage)</summary>
      <div class="accordion-content">
        <p style="font-size:12px; color:#ccc;">Votre date de naissance génère un déphasage unique, symbolisant votre propre "signature" dans le Moiré Cosmique.</p>
        <label for="birthdate">Date de naissance :</label>
        <input type="date" id="birthdate">
      </div>
    </details>

    <details open>
      <summary>Réglages & Scan</summary>
      <div class="accordion-content">
        <label>n (Φⁿ): <span id="nVal"></span><input type="range" id="phiSlider" min="-10" max="10" step="0.01" value="2"></label>
        <label>m (2ᵐ): <span id="mVal"></span><input type="range" id="twoSlider" min="-10" max="10" step="0.01" value="2"></label>
        <label>Fréquence de base f₀: <span id="f0Val"></span><input type="range" id="baseFreq" min="0.1" max="10" step="0.1" value="1"></label>
        <label>Zoom Visuel: <span id="zoomVal"></span><input type="range" id="zoom" min="50" max="800" step="10" value="200"></label>
        <button id="scanBtn">▶ Lancer le Scan des Cohérences</button>
        <div id="scan-status"></div>
      </div>
    </details>

    <details open>
        <summary>Top 10 Cohérences</summary>
        <div class="accordion-content" id="top-coherences">
            <p style="font-size:12px; color:#ccc;">Cliquez sur ▶ pour entendre et voir la résonance associée.</p>
            <ul></ul>
        </div>
    </details>
  </div>

  <script>
    const phi = (1 + Math.sqrt(5)) / 2;
    let nSlider, mSlider, f0Slider, zoomSlider, scanBtn, birthdateInput;
    let nValSpan, mValSpan, f0ValSpan, zoomValSpan;
    let fPhiDisplay, fTwoDisplay, coherenceDisplay;

    let phiOffset = 0, twoOffset = 0;
    let topCoherences = [];
    let scanStatusDiv;

    let oscPhi, oscTwo;
    let playingIndex = -1;

    function setup() {
      createCanvas(windowWidth, windowHeight);
      colorMode(HSB, 360, 100, 100);

      nSlider = select('#phiSlider');
      mSlider = select('#twoSlider');
      f0Slider = select('#baseFreq');
      zoomSlider = select('#zoom');
      scanBtn = select('#scanBtn');
      birthdateInput = select('#birthdate');

      nValSpan = select('#nVal');
      mValSpan = select('#mVal');
      f0ValSpan = select('#f0Val');
      zoomValSpan = select('#zoomVal');

      fPhiDisplay = select('#fPhiDisplay');
      fTwoDisplay = select('#fTwoDisplay');
      coherenceDisplay = select('#coherenceDisplay');
      scanStatusDiv = select('#scan-status');

      scanBtn.mousePressed(runFullScan);
      birthdateInput.input(handleDateInput);

      oscPhi = new p5.Oscillator('sine');
      oscTwo = new p5.Oscillator('sine');

      noFill();
      frameRate(30);
    }

    function handleDateInput() {
      const dateVal = birthdateInput.value();
      if (dateVal) {
        const [year, month, day] = dateVal.split('-').map(Number);
        const seed = year + month * 31 + day * 365;
        phiOffset = map(sin(seed), -1, 1, -PI, PI);
        twoOffset = map(cos(seed * phi), -1, 1, -PI, PI);
      } else {
        phiOffset = 0;
        twoOffset = 0;
      }
    }

    function draw() {
      let n = parseFloat(nSlider.value());
      let m = parseFloat(mSlider.value());
      let f0 = parseFloat(f0Slider.value());
      let zoom = parseFloat(zoomSlider.value());

      nValSpan.html(`(${n.toFixed(2)})`);
      mValSpan.html(`(${m.toFixed(2)})`);
      f0ValSpan.html(`(${f0.toFixed(1)} Hz)`);
      zoomValSpan.html(`(${zoom})`);

      let fPhi = f0 * Math.pow(phi, n);
      let fTwo = f0 * Math.pow(2, m);

      let coherenceRatio = Math.min(fPhi, fTwo) / Math.max(fPhi, fTwo);
      let coherence = Math.pow(coherenceRatio, 4);

      fPhiDisplay.html(`${fPhi.toFixed(2)} Hz`);
      fTwoDisplay.html(`${fTwo.toFixed(2)} Hz`);
      coherenceDisplay.html(`${(coherence * 100).toFixed(1)}%`);

      let bgColor = lerpColor(color(240, 80, 10), color(120, 80, 20), coherence);
      background(bgColor);

      translate(width / 2, height / 2);

      drawWave(fPhi, color(60, 100, 100, 0.7), zoom, phiOffset);
      drawWave(fTwo, color(195, 100, 100, 0.7), zoom, twoOffset);
      drawInterference(fPhi, fTwo, color(0, 0, 100, 1), zoom);
    }

    function drawWave(freq, strokeColor, zoom, phaseOffset) {
      stroke(strokeColor);
      strokeWeight(2);
      beginShape();
      for (let x = -width / 2; x < width / 2; x++) {
        let t = x / zoom;
        let y = Math.sin(TWO_PI * freq * t + phaseOffset);
        vertex(x, y * (zoom / 2));
      }
      endShape();
    }

    function drawInterference(freq1, freq2, strokeColor, zoom) {
      stroke(strokeColor);
      strokeWeight(3);
      beginShape();
      for (let x = -width / 2; x < width / 2; x++) {
        let t = x / zoom;
        let y1 = Math.sin(TWO_PI * freq1 * t + phiOffset);
        let y2 = Math.sin(TWO_PI * freq2 * t + twoOffset);
        vertex(x, (y1 * y2) * (zoom / 2));
      }
      endShape();
    }

    function runFullScan() {
      scanStatusDiv.html('Scan en cours...');
      setTimeout(() => {
        let results = [];
        let f0 = parseFloat(f0Slider.value());
        let step = 0.1;

        for (let n = -10; n <= 10; n += step) {
          for (let m = -10; m <= 10; m += step) {
            // ***MODIFICATION : Filtre le cas trivial n=0, m=0***
            if (Math.abs(n) < 0.001 && Math.abs(m) < 0.001) continue;

            let fPhi = f0 * Math.pow(phi, n);
            let fTwo = f0 * Math.pow(2, m);
            let coherence = Math.exp(-10 * Math.abs(Math.log(fPhi / fTwo)));

            if (coherence > 0.01) {
                 results.push({ n: n, m: m, coherence: coherence, fPhi: fPhi, fTwo: fTwo });
            }
          }
        }

        results.sort((a, b) => b.coherence - a.coherence);
        topCoherences = results.slice(0, 10);
        displayTopCoherences();
        scanStatusDiv.html('Scan terminé.');
      }, 50);
    }

    function displayTopCoherences() {
        let ul = select('#top-coherences ul');
        ul.html('');

        if (topCoherences.length === 0) return;

        let minF = Math.min(...topCoherences.map(r => r.fPhi));
        let maxF = Math.max(...topCoherences.map(r => r.fPhi));

        topCoherences.forEach((res, index) => {
            let li = createElement('li');

            let hue = map(log(res.fPhi), log(minF), log(maxF), 0, 360);
            let swatch = createDiv('');
            swatch.class('color-swatch');
            swatch.style('background-color', `hsl(${hue}, 100%, 50%)`);

            let info = createDiv(`Coherence: <b>${(res.coherence * 100).toFixed(1)}%</b><br>n=${res.n.toFixed(2)}, m=${res.m.toFixed(2)}`);

            let playBtn = createButton('▶');
            playBtn.class('play-btn');
            playBtn.mousePressed(() => toggleSound(index));

            swatch.parent(li);
            info.parent(li);
            playBtn.parent(li);
            li.parent(ul);
        });
    }

    function toggleSound(index) {
        const buttons = selectAll('.play-btn');

        if (playingIndex === index) {
            oscPhi.stop();
            oscTwo.stop();
            buttons[index].html('▶');
            buttons[index].removeClass('playing');
            playingIndex = -1;
        } else {
            if (playingIndex !== -1) {
                oscPhi.stop();
                oscTwo.stop();
                buttons[playingIndex].html('▶');
                buttons[playingIndex].removeClass('playing');
            }

            playingIndex = index;
            let res = topCoherences[index];

            // ***MODIFICATION : Met à jour les sliders pour la synchronisation visuelle***
            nSlider.value(res.n);
            mSlider.value(res.m);

            let audibleMin = 100;
            let audibleMax = 1500;

            let minF = Math.min(...topCoherences.map(r => Math.min(r.fPhi, r.fTwo)));
            let maxF = Math.max(...topCoherences.map(r => Math.max(r.fPhi, r.fTwo)));

            let audiblePhi = map(log(res.fPhi), log(minF), log(maxF), audibleMin, audibleMax);
            let audibleTwo = map(log(res.fTwo), log(minF), log(maxF), audibleMin, audibleMax);

            oscPhi.freq(audiblePhi);
            oscTwo.freq(audibleTwo);
            oscPhi.amp(0.2);
            oscTwo.amp(0.2);

            oscPhi.start();
            oscTwo.start();

            buttons[index].html('⏹');
            buttons[index].addClass('playing');
        }
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
    }
  </script>
</body>
</html>
